// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USER MANAGEMENT
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  avatar    String?
  
  // Relations
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  
  // Activity tracking
  createdTasks    Task[]          @relation("TaskCreator")
  completedTasks  TaskExecution[] @relation("TaskExecutor")
  createdFlows    Flow[]          @relation("FlowCreator")
  initiatedFlows  FlowInstance[]  @relation("FlowInitiator")
  auditLogs       AuditLog[]
  clientTaskCompletions ClientTaskCompletion[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  @@index([email])
  @@index([companyId])
  @@map("users")
}

enum UserRole {
  DEVELOPER
  ADMIN
  MANAGER
  EMPLOYEE
}

// ============================================
// 2. COMPANY & HIERARCHY
// ============================================

model Company {
  id          String  @id @default(uuid())
  name        String
  domain      String? @unique
  logo        String?
  isActive    Boolean @default(true)
  
  // Customization
  primaryColor   String @default("#3B82F6")
  secondaryColor String @default("#1A1F2E")
  
  // Relations
  users        User[]
  departments  Department[]
  roles        Role[]
  tasks        Task[]
  flows        Flow[]
  datasets     Dataset[]
  tables       CustomTable[]
  integrations Integration[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("companies")
}

model Department {
  id          String  @id @default(uuid())
  name        String
  description String?
  parentId    String?
  
  // Relations
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent    Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children  Department[] @relation("DepartmentHierarchy")
  roles     Role[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([companyId])
  @@index([parentId])
  @@map("departments")
}

model Role {
  id          String  @id @default(uuid())
  name        String
  description String?
  permissions Json    @default("{}")
  
  // Relations
  companyId    String
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  
  flowLevels FlowLevel[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([companyId, name])
  @@index([companyId])
  @@map("roles")
}

// ============================================
// 3. TASKS
// ============================================

model Task {
  id          String      @id @default(uuid())
  name        String
  description String?
  version     String      @default("1.0")
  status      TaskStatus  @default(DRAFT)
  
  // Task Definition (JSON structure)
  fields      Json        // Array of field definitions
  validations Json        @default("[]")
  logic       Json        @default("{}") // Conditional logic
  
  // Metadata
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdById String
  createdBy   User   @relation("TaskCreator", fields: [createdById], references: [id])
  
  // Relations
  flowLevelTasks FlowLevelTask[]
  executions     TaskExecution[]
  triggers       Trigger[]
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  
  @@index([companyId])
  @@index([status])
  @@map("tasks")
}

enum TaskStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  DEPRECATED
}

model TaskExecution {
  id       String @id @default(uuid())
  
  // Task reference
  taskId   String
  task     Task   @relation(fields: [taskId], references: [id])
  
  // Data submitted
  data     Json   // Task field values
  
  // Execution context
  executorId String
  executor   User   @relation("TaskExecutor", fields: [executorId], references: [id])
  
  // Flow context (if task is part of flow)
  flowInstanceId String?
  flowInstance   FlowInstance? @relation(fields: [flowInstanceId], references: [id])
  levelId        String?
  
  // Status
  status        ExecutionStatus @default(COMPLETED)
  completedAt   DateTime        @default(now())
  
  createdAt DateTime @default(now())
  
  @@index([taskId])
  @@index([executorId])
  @@index([flowInstanceId])
  @@map("task_executions")
}

enum ExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// 4. FLOWS
// ============================================

model Flow {
  id          String     @id @default(uuid())
  name        String
  description String?
  version     String     @default("1.0")
  status      FlowStatus @default(DRAFT)
  
  // Flow configuration
  config      Json       @default("{}")
  
  // Relations
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdById String
  createdBy   User       @relation("FlowCreator", fields: [createdById], references: [id])
  
  levels      FlowLevel[]
  branches    FlowBranch[]
  instances   FlowInstance[]
  triggers    Trigger[]
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  
  @@index([companyId])
  @@index([status])
  @@map("flows")
}

enum FlowStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  ARCHIVED
}

model FlowLevel {
  id          String  @id @default(uuid())
  name        String
  description String?
  order       Int     // Sequential order
  
  // Relations
  flowId      String
  flow        Flow    @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  // Level configuration
  config      Json    @default("{}")
  
  // Task assignments
  tasks       FlowLevelTask[]
  roles       Role[]
  
  // Branching (outgoing branches from this level)
  outgoingBranches FlowBranch[] @relation("BranchFrom")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([flowId, order])
  @@index([flowId])
  @@map("flow_levels")
}

model FlowLevelTask {
  id      String @id @default(uuid())
  
  levelId String
  level   FlowLevel @relation(fields: [levelId], references: [id], onDelete: Cascade)
  
  taskId  String
  task    Task   @relation(fields: [taskId], references: [id])
  
  order   Int
  config  Json   @default("{}")
  
  createdAt DateTime @default(now())
  
  @@unique([levelId, order])
  @@index([levelId])
  @@index([taskId])
  @@map("flow_level_tasks")
}

model FlowBranch {
  id          String @id @default(uuid())
  name        String
  
  // Branch routing
  fromLevelId String
  fromLevel   FlowLevel @relation("BranchFrom", fields: [fromLevelId], references: [id], onDelete: Cascade)
  
  toLevelId   String
  
  // Conditions (JSON structure)
  conditions  Json
  
  // Priority (lower number = higher priority)
  priority    Int    @default(0)
  
  // Relations
  flowId      String
  flow        Flow   @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([flowId])
  @@index([fromLevelId])
  @@map("flow_branches")
}

// Flow execution instances
model FlowInstance {
  id          String             @id @default(uuid())
  
  // Flow reference
  flowId      String
  flow        Flow               @relation(fields: [flowId], references: [id])
  
  // Current state
  currentLevelOrder Int          @default(1)
  status      FlowInstanceStatus @default(IN_PROGRESS)
  
  // Context data
  contextData Json               @default("{}")
  
  // Initiator
  initiatorId String
  initiator   User               @relation("FlowInitiator", fields: [initiatorId], references: [id])
  
  // Relations
  taskExecutions TaskExecution[]
  
  // Timestamps
  startedAt   DateTime           @default(now())
  completedAt DateTime?
  
  @@index([flowId])
  @@index([status])
  @@map("flow_instances")
}

enum FlowInstanceStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// 5. TRIGGERS & AUTOMATION
// ============================================

model Trigger {
  id          String        @id @default(uuid())
  name        String
  description String?
  isActive    Boolean       @default(true)
  
  // Event configuration
  eventType   EventType
  eventConfig Json          @default("{}")
  
  // Conditions (JSON structure)
  conditions  Json?
  
  // Actions (JSON array)
  actions     Json          // Array of action configurations
  
  // Advanced settings
  settings    Json          @default("{}")
  
  // Context (attached to task or flow)
  taskId      String?
  task        Task?         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  flowId      String?
  flow        Flow?         @relation(fields: [flowId], references: [id], onDelete: Cascade)
  
  // Execution logs
  executions  TriggerExecution[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([eventType])
  @@index([taskId])
  @@index([flowId])
  @@map("triggers")
}

enum EventType {
  TASK_COMPLETED
  TASK_STARTED
  TASK_UPDATED
  FIELD_CHANGED
  FLOW_STARTED
  FLOW_COMPLETED
  DATABASE_ROW_CREATED
  DATABASE_ROW_UPDATED
  SCHEDULED
  WEBHOOK_RECEIVED
}

model TriggerExecution {
  id              String   @id @default(uuid())
  
  triggerId       String
  trigger         Trigger  @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  
  // Event data
  eventData       Json
  
  // Evaluation results
  conditionsMet   Boolean
  conditionResult Json     // Detailed evaluation
  
  // Actions executed
  actionsExecuted Json
  
  // Status
  status          TriggerExecutionStatus @default(SUCCESS)
  errorMessage    String?
  
  // Performance
  executionTime   Int      // milliseconds
  
  executedAt DateTime @default(now())
  
  @@index([triggerId])
  @@index([status])
  @@index([executedAt])
  @@map("trigger_executions")
}

// ============================================
// 10. CLIENT PORTAL
// ============================================

model ClientTaskCompletion {
  // Who completed it
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Arbitrary client task identifier (e.g. "EXP-1523")
  clientTaskId String

  // Submitted data from the client form
  data Json

  completedAt DateTime @default(now())

  @@id([userId, clientTaskId])
  @@map("client_task_completions")
}

enum TriggerExecutionStatus {
  SUCCESS
  PARTIAL_SUCCESS
  FAILED
}

// ============================================
// 6. DATASETS
// ============================================

model Dataset {
  id          String        @id @default(uuid())
  name        String
  description String?
  category    String?
  
  // Sections (JSON array)
  sections    Json
  
  // Access control
  visibility  Json          @default("{}")
  
  // Relations
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  status      DatasetStatus @default(DRAFT)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  publishedAt DateTime?
  
  @@index([companyId])
  @@map("datasets")
}

enum DatasetStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================
// 7. CUSTOM DATABASE (Dynamic Tables)
// ============================================

model CustomTable {
  id          String  @id @default(uuid())
  name        String
  displayName String
  description String?
  
  // Schema definition (JSON)
  schema      Json    // Field definitions, types, validations
  
  // Relations definition (JSON)
  relations   Json    @default("[]")
  
  // Settings
  settings    Json    @default("{}")
  
  // Relations
  companyId   String
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  records     CustomTableRecord[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([companyId, name])
  @@index([companyId])
  @@map("custom_tables")
}

model CustomTableRecord {
  id      String      @id @default(uuid())
  
  tableId String
  table   CustomTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  
  // Actual data (JSON)
  data    Json
  
  // Metadata
  createdBy String?
  updatedBy String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete
  
  @@index([tableId])
  @@index([deletedAt])
  @@map("custom_table_records")
}

// ============================================
// 8. INTEGRATIONS
// ============================================

model Integration {
  id          String            @id @default(uuid())
  name        String
  type        IntegrationType
  isActive    Boolean           @default(true)
  
  // Configuration (API keys, etc.)
  config      Json
  
  // Relations
  companyId   String
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Activity
  workflows   IntegrationWorkflow[]
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  lastSyncAt  DateTime?
  
  @@index([companyId])
  @@index([type])
  @@map("integrations")
}

enum IntegrationType {
  GMAIL
  GOOGLE_SHEETS
  OUTLOOK
  TALLY
  ZOHO
  WEBHOOK
  CUSTOM_API
}

model IntegrationWorkflow {
  id            String      @id @default(uuid())
  name          String
  
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  // Trigger and action configuration
  triggerConfig Json
  actionConfig  Json
  
  isActive      Boolean     @default(true)
  
  // Execution stats
  executionCount Int        @default(0)
  lastExecutedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([integrationId])
  @@map("integration_workflows")
}

// ============================================
// 9. AUDIT LOGS
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  
  // Who did it
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // What was done
  action      String   // e.g., "task.created", "flow.updated"
  entity      String   // e.g., "Task", "Flow"
  entityId    String
  
  // Details
  changes     Json?    // Before/after for updates
  metadata    Json     @default("{}")
  
  // Context
  ipAddress   String?
  userAgent   String?
  
  // Severity
  level       LogLevel @default(INFO)
  
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ============================================
// 10. VERSIONS & RELEASES
// ============================================

model Version {
  id          String        @id @default(uuid())
  version     String        // e.g., "3.1.0"
  
  // What changed
  entityType  String        // "Task", "Flow", etc.
  entityId    String
  
  // Version data snapshot
  snapshot    Json
  
  // Change information
  changes     String?
  changeLog   Json          @default("[]")
  
  // Status
  status      VersionStatus @default(DRAFT)
  
  // Deployment
  rolloutPercentage Int     @default(0)
  deployedToClients Json    @default("[]")
  
  // Metadata
  createdBy   String
  
  createdAt   DateTime      @default(now())
  publishedAt DateTime?
  
  @@index([entityType, entityId])
  @@index([version])
  @@map("versions")
}

enum VersionStatus {
  DRAFT
  PUBLISHED
  STABLE
  DEPRECATED
}

// ============================================
// 11. FILE UPLOADS
// ============================================

model File {
  id          String   @id @default(uuid())
  filename    String
  originalName String
  mimetype    String
  size        Int
  path        String
  
  // Context
  uploadedBy  String
  context     String?  // "task_attachment", "avatar", etc.
  contextId   String?  // Related entity ID
  
  uploadedAt  DateTime @default(now())
  
  @@index([context, contextId])
  @@map("files")
}

// ============================================
// 12. EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String   @id @default(uuid())
  name        String
  subject     String
  body        String   @db.Text
  
  // Variables used in template
  variables   Json     @default("[]")
  
  // Template type
  type        String   // "notification", "approval_request", etc.
  
  isActive    Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("email_templates")
}
